schemaVersion: "2.0.0"

containerRunOptions:
  user: "dev"

commandTests:
  - name: "nix is available"
    command: "/nix/var/nix/profiles/default/bin/nix"
    args: ["--version"]
    expectedOutput: ["nix \\(Nix\\)"]

  - name: "git is available"
    command: "/nix/var/nix/profiles/default/bin/git"
    args: ["--version"]
    expectedOutput: ["git version"]

  - name: "direnv is available"
    command: "/nix/var/nix/profiles/default/bin/direnv"
    args: ["version"]
    expectedOutput: ["[0-9]+\\.[0-9]+"]

  - name: "apt-get is available (Ubuntu base)"
    command: "bash"
    args: ["-lc", "apt-get --version"]
    expectedOutput: ["apt"]

  # --- Home Manager dotfiles: ownership + store path resolution ---

  - name: "/home/dev owned by dev user"
    command: "stat"
    args: ["-c", "%U:%G", "/home/dev"]
    expectedOutput: ["dev:dev"]

  - name: "/home/dev/.bashrc owned by dev user"
    command: "stat"
    args: ["-c", "%U:%G", "/home/dev/.bashrc"]
    expectedOutput: ["dev:dev"]

  - name: ".profile sources without missing store paths"
    command: "bash"
    args: ["-c", ". /home/dev/.profile 2>&1 && echo ok"]
    expectedOutput: ["ok"]
    excludedOutput: ["No such file"]

  - name: "login shell works (VS Code Codespaces compatibility)"
    command: "bash"
    args: ["-l", "-c", "echo probe-ok"]
    expectedOutput: ["probe-ok"]
    excludedOutput: ["No such file or directory"]

  # Negative: no shell-specific tools
  - name: "base does NOT contain python3"
    command: "bash"
    args: ["-lc", "! find /nix/store -maxdepth 3 -path '*/bin/python3' \\( -type f -o -type l \\) 2>/dev/null | grep -q ."]
    exitCode: 0

  - name: "base does NOT contain go"
    command: "bash"
    args: ["-lc", "! find /nix/store -maxdepth 3 -path '*/bin/go' \\( -type f -o -type l \\) 2>/dev/null | grep -q ."]
    exitCode: 0

  - name: "base does NOT contain java"
    command: "bash"
    args: ["-lc", "! find /nix/store -path '*/bin/java' \\( -type f -o -type l \\) 2>/dev/null | grep -q ."]
    exitCode: 0

  - name: "base does NOT contain kubectl"
    command: "bash"
    args: ["-lc", "! find /nix/store -maxdepth 3 -path '*/bin/kubectl' \\( -type f -o -type l \\) 2>/dev/null | grep -q ."]
    exitCode: 0
